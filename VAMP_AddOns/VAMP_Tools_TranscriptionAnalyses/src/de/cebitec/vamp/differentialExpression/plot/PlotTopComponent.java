package de.cebitec.vamp.differentialExpression.plot;

import de.cebitec.vamp.databackend.dataObjects.PersistantFeature;
import de.cebitec.vamp.differentialExpression.DeAnalysisHandler;
import de.cebitec.vamp.differentialExpression.ResultDeAnalysis;
import de.cebitec.vamp.plotting.CreatePlots;
import de.cebitec.vamp.util.FeatureType;
import de.cebitec.vamp.util.Observer;
import java.util.ArrayList;
import java.util.List;
import de.cebitec.vamp.util.Pair;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Random;
import javax.swing.DefaultComboBoxModel;
import org.jfree.chart.ChartPanel;
import org.netbeans.api.settings.ConvertAsProperties;
import org.openide.awt.ActionID;
import org.openide.awt.ActionReference;
import org.openide.windows.TopComponent;
import org.openide.util.NbBundle.Messages;

/**
 * Top component which displays something.
 */
@ConvertAsProperties(
        dtd = "-//de.cebitec.vamp.differentialExpression.plot//Plot//EN",
        autostore = false)
@TopComponent.Description(
        preferredID = "PlotTopComponent",
        //iconBase="SET/PATH/TO/ICON/HERE", 
        persistenceType = TopComponent.PERSISTENCE_NEVER)
@TopComponent.Registration(mode = "editor", openAtStartup = false)
@ActionID(category = "Tools", id = "de.cebitec.vamp.differentialExpression.plot.PlotTopComponent")
@ActionReference(path = "Menu/Tools")
@TopComponent.OpenActionRegistration(
        displayName = "#CTL_PlotAction",
        preferredID = "PlotTopComponent")
@Messages({
    "CTL_PlotAction=Plot",
    "CTL_PlotTopComponent=Create graphics",
    "HINT_PlotTopComponent=This is a Plot window"
})
public final class PlotTopComponent extends TopComponent implements Observer {

    private DefaultComboBoxModel<PlotTypes> cbmPlotType = new DefaultComboBoxModel<>(PlotTypes.values());
    private DefaultComboBoxModel<String> cbmDataSet;
    private DeAnalysisHandler analysisHandler;
    private List<ResultDeAnalysis> results;
    private DeAnalysisHandler.Tool usedTool;
    private MouseActions mouseAction = new MouseActions();

    public PlotTopComponent() {
        cbmDataSet = new DefaultComboBoxModel<>();
        initComponents();
        setName(Bundle.CTL_PlotTopComponent());
        setToolTipText(Bundle.HINT_PlotTopComponent());
        ChartPanel panel = CreatePlots.createInfPlot(createSamplePoints(500), "X", "Y", new ToolTip());
        panel.addChartMouseListener(mouseAction);
        plotPanel.add(panel);
        plotPanel.updateUI();

    }

    public PlotTopComponent(DeAnalysisHandler analysisHandler, DeAnalysisHandler.Tool usedTool) {
        this.analysisHandler = analysisHandler;
        this.usedTool = usedTool;
        results = analysisHandler.getResults();
        List<String> descriptions = new ArrayList<>();
        for (Iterator<ResultDeAnalysis> it = results.iterator(); it.hasNext();) {
            ResultDeAnalysis currentResult = it.next();
            descriptions.add(currentResult.getDescription());
        }
        cbmDataSet = new DefaultComboBoxModel<>(descriptions.toArray(new String[descriptions.size()]));
        initComponents();
        setName(Bundle.CTL_PlotTopComponent());
        setToolTipText(Bundle.HINT_PlotTopComponent());
    }

    public Map<PersistantFeature, Pair<Double, Double>> createSamplePoints(int n) {
        Random r = new Random(System.nanoTime());
        Map<PersistantFeature, Pair<Double, Double>> points = new HashMap<>();
        for (int i = 0; i < n; i++) {
            PersistantFeature dummyFeature = new PersistantFeature(0, "", "", "", "", 0, 0, true, FeatureType.ANY, "");
            double random = Math.random();
            if (random > 0.95) {
                points.put(dummyFeature, new Pair<>(r.nextDouble() * 256.0d, Double.POSITIVE_INFINITY));
                points.put(dummyFeature, new Pair<>(r.nextDouble() * 256.0d, Double.NEGATIVE_INFINITY));
            } else {
                points.put(dummyFeature, new Pair<>(2 * i + (r.nextGaussian() - 0.5d), r.nextDouble() * 256.0d));
            }
        }
        PersistantFeature dummyFeature = new PersistantFeature(0, "", "", "", "", 0, 0, true, FeatureType.ANY, "");
        points.put(dummyFeature, new Pair<>(200d, 300d));
        dummyFeature = new PersistantFeature(0, "", "", "", "", 0, 0, true, FeatureType.ANY, "");
        points.put(dummyFeature, new Pair<>(100d, Double.POSITIVE_INFINITY));
        return points;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        dataSetComboBox = new javax.swing.JComboBox();
        plotTypeComboBox = new javax.swing.JComboBox();
        createPlotButton = new javax.swing.JButton();
        clearPlotsButton = new javax.swing.JButton();
        plotPanel = new javax.swing.JPanel();

        org.openide.awt.Mnemonics.setLocalizedText(jLabel1, org.openide.util.NbBundle.getMessage(PlotTopComponent.class, "PlotTopComponent.jLabel1.text")); // NOI18N

        org.openide.awt.Mnemonics.setLocalizedText(jLabel2, org.openide.util.NbBundle.getMessage(PlotTopComponent.class, "PlotTopComponent.jLabel2.text")); // NOI18N

        dataSetComboBox.setModel(cbmDataSet);

        plotTypeComboBox.setModel(cbmPlotType);

        org.openide.awt.Mnemonics.setLocalizedText(createPlotButton, org.openide.util.NbBundle.getMessage(PlotTopComponent.class, "PlotTopComponent.createPlotButton.text")); // NOI18N
        createPlotButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                createPlotButtonActionPerformed(evt);
            }
        });

        org.openide.awt.Mnemonics.setLocalizedText(clearPlotsButton, org.openide.util.NbBundle.getMessage(PlotTopComponent.class, "PlotTopComponent.clearPlotsButton.text")); // NOI18N
        clearPlotsButton.setEnabled(false);
        clearPlotsButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                clearPlotsButtonActionPerformed(evt);
            }
        });

        plotPanel.setLayout(new javax.swing.BoxLayout(plotPanel, javax.swing.BoxLayout.LINE_AXIS));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(plotPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1)
                            .addComponent(jLabel2))
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(dataSetComboBox, 0, 211, Short.MAX_VALUE)
                            .addComponent(plotTypeComboBox, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(clearPlotsButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(createPlotButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel1)
                        .addComponent(dataSetComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(createPlotButton))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(plotTypeComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel2))
                    .addComponent(clearPlotsButton))
                .addGap(18, 18, 18)
                .addComponent(plotPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void createPlotButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_createPlotButtonActionPerformed
        PlotTypes type = (PlotTypes) cbmPlotType.getSelectedItem();
        int index = dataSetComboBox.getSelectedIndex();
        ResultDeAnalysis result = results.get(index);
        ChartPanel panel;
        switch (type) {
            case MA_Plot:
                panel = CreatePlots.createInfPlot(ConvertData.createMAvalues(result, usedTool, null, null), "A", "M", new ToolTip());
                panel.addChartMouseListener(mouseAction);
                plotPanel.add(panel);
                plotPanel.updateUI();
                break;
            case RatioAB_Confidence:
                panel = CreatePlots.createPlot(ConvertData.ratioABagainstConfidence(result), "ratioAB", "Confidence", new ToolTip());
                panel.addChartMouseListener(mouseAction);
                plotPanel.add(panel);
                plotPanel.updateUI();
                break;
            case RatioBA_Confidence:
                panel = CreatePlots.createPlot(ConvertData.ratioBAagainstConfidence(result), "ratioBA", "Confidence", new ToolTip());
                panel.addChartMouseListener(mouseAction);
                plotPanel.add(panel);
                plotPanel.updateUI();
                break;
        }
        clearPlotsButton.setEnabled(true);
    }//GEN-LAST:event_createPlotButtonActionPerformed

    private void clearPlotsButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_clearPlotsButtonActionPerformed
        clearPlotsButton.setEnabled(false);
        plotPanel.removeAll();
        plotPanel.updateUI();
    }//GEN-LAST:event_clearPlotsButtonActionPerformed
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton clearPlotsButton;
    private javax.swing.JButton createPlotButton;
    private javax.swing.JComboBox dataSetComboBox;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel plotPanel;
    private javax.swing.JComboBox plotTypeComboBox;
    // End of variables declaration//GEN-END:variables

    @Override
    public void componentOpened() {
        // TODO add custom code on component opening
    }

    @Override
    public void componentClosed() {
        if (analysisHandler != null) {
            analysisHandler.removeObserver(this);
        }
    }

    void writeProperties(java.util.Properties p) {
        // better to version settings since initial version as advocated at
        // http://wiki.apidesign.org/wiki/PropertyFiles
        p.setProperty("version", "1.0");
        // TODO store your settings
    }

    void readProperties(java.util.Properties p) {
        String version = p.getProperty("version");
        // TODO read your settings according to their version
    }

    @Override
    public void update(Object args) {
    }

    public static enum PlotTypes {

        MA_Plot("MA Plot"), RatioAB_Confidence("Ratio A/B against Confidence"),
        RatioBA_Confidence("Ratio B/A against Confidence");
        private String name;

        private PlotTypes(String name) {
            this.name = name;
        }

        @Override
        public String toString() {
            return name;
        }
    }
}
